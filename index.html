<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<title>Day Tracker</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1a2e;--card:#16213e;--card-border:#0f3460;
  --text:#e0e0e0;--text-dim:#8a8a9a;--text-bright:#ffffff;
  --accent:#53d2dc;--amber:#e8a838;--green:#4caf50;--red:#e85d5d;
  --radius:14px;--shadow:0 2px 12px rgba(0,0,0,.35);
  --tap:44px;
}
html{font-size:16px;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;-webkit-tap-highlight-color:transparent}
body{min-height:100dvh;padding:0 0 80px}
button,input,select{font:inherit;color:inherit;background:none;border:none;outline:none}
button{cursor:pointer;-webkit-user-select:none;user-select:none}

/* ── NAV ── */
.nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--card-border);z-index:100;padding:6px 0 env(safe-area-inset-bottom,6px)}
.nav button{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 0;font-size:.7rem;color:var(--text-dim);transition:color .15s}
.nav button.active{color:var(--accent)}
.nav-ic{width:20px;height:20px}

/* ── HEADER ── */
.header{padding:16px 16px 8px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:1.25rem;font-weight:700;color:var(--text-bright)}
.header .date{font-size:.85rem;color:var(--text-dim)}

/* ── CARDS ── */
.card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);margin:10px 14px;box-shadow:var(--shadow);overflow:hidden}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;min-height:var(--tap);cursor:pointer;-webkit-user-select:none;user-select:none}
.card-head h2{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px}
.ic{width:18px;height:18px;color:var(--text-dim);flex-shrink:0}
.wake-compact{padding:10px 16px}
.wake-time-inline{padding:6px 10px;font-size:.9rem;min-height:36px;width:auto}
.card-head .chevron{font-size:.75rem;color:var(--text-dim);transition:transform .2s}
.card.collapsed .card-body{display:none}
.card.collapsed .chevron{transform:rotate(-90deg)}
.card-body{padding:4px 16px 16px}

/* ── PILLS ── */
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{min-height:var(--tap);padding:8px 16px;border-radius:22px;background:var(--bg);border:1.5px solid var(--card-border);font-size:.9rem;transition:all .15s;display:flex;align-items:center;justify-content:center}
.pill.active{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:600}

/* ── EMOJI PICKER ── */
.emoji-row{display:flex;gap:6px}
.emoji-btn{width:var(--tap);height:var(--tap);font-size:1.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s;border:2px solid transparent}
.emoji-btn.active{border-color:var(--accent);background:rgba(83,210,220,.15);transform:scale(1.15)}

/* ── CHECKLIST ── */
.check-row{display:flex;align-items:center;gap:12px;min-height:var(--tap);padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.check-row:last-child{border-bottom:none}
.checkbox{width:26px;height:26px;border-radius:7px;border:2px solid var(--card-border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;font-size:.85rem}
.check-row.checked .checkbox{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.check-row .label{font-size:.95rem;flex:1}
.check-row.checked .label{color:var(--text-dim);text-decoration:line-through}

/* ── PRIORITY ROW ── */
.priority-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.priority-row .checkbox{cursor:pointer}
.priority-row input[type="text"]{flex:1;background:var(--bg);border:1.5px solid var(--card-border);border-radius:8px;padding:8px 10px;font-size:.9rem;color:var(--text-bright);min-height:var(--tap);box-sizing:border-box}
.priority-row.checked input[type="text"]{color:var(--text-dim);text-decoration:line-through}

/* ── TIME INPUT ── */
.time-input{background:var(--bg);border:1.5px solid var(--card-border);border-radius:10px;padding:10px 14px;font-size:1rem;color:var(--text-bright);min-height:var(--tap)}

/* ── FIELD ROW ── */
.field{margin-bottom:14px}
.field:last-child{margin-bottom:0}
.field label{display:block;font-size:.8rem;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}

/* ── TODAY PROGRESS ── */
.today-progress{margin:0 14px 12px;padding:12px 14px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius)}
.today-progress .tp-bar-track{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:8px}
.today-progress .tp-bar-fill{height:100%;border-radius:4px;background:var(--accent);transition:width .3s}
.today-progress .tp-stats{display:flex;justify-content:space-between;font-size:.75rem;color:var(--text-dim)}
.today-progress .tp-pct{font-size:.85rem;font-weight:700;color:var(--text-bright);margin-bottom:4px}
.today-progress .tp-streaks{display:flex;gap:14px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.05);font-size:.75rem;color:var(--text-dim)}
.today-progress .tp-streaks .tp-streak{display:flex;align-items:center;gap:4px}
.today-progress .tp-streaks .tp-snum{font-weight:700;color:var(--amber);font-size:.85rem}

.big-btn{width:100%;min-height:54px;border-radius:var(--radius);font-size:1.05rem;font-weight:600;transition:all .15s}
.big-btn.start{background:var(--accent);color:var(--bg)}

/* ── HISTORY ── */
.streaks{display:flex;gap:10px;padding:0 14px;margin-bottom:12px;flex-wrap:wrap}
.streak-box{flex:1;min-width:90px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:12px;text-align:center}
.streak-box .num{font-size:1.6rem;font-weight:700;color:var(--amber)}
.streak-box .lbl{font-size:.7rem;color:var(--text-dim);margin-top:2px}
.streak-recovery{font-size:.65rem;color:var(--green);margin-top:4px;line-height:1.3}
.date-strip{display:flex;gap:6px;overflow-x:auto;padding:0 14px 10px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.date-strip::-webkit-scrollbar{display:none}
.date-dot{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:44px;padding:8px 4px;border-radius:10px;cursor:pointer;transition:all .15s}
.date-dot.sel{background:var(--card);border:1px solid var(--accent)}
.date-dot .day{font-size:.7rem;color:var(--text-dim)}
.date-dot .num{font-size:1rem;font-weight:600}
.date-dot .dot{width:8px;height:8px;border-radius:50%}
.dot-green{background:var(--green)}
.dot-yellow{background:var(--amber)}
.dot-gray{background:#444}
.history-summary{margin:0 14px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px}
.history-summary h3{font-size:.95rem;margin-bottom:12px;color:var(--text-bright)}
.summary-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:.9rem}
.summary-row:last-child{border-bottom:none}
.summary-row .k{color:var(--text-dim)}

/* ── WEEKLY REVIEW ── */
.weekly-section{margin:0 14px 14px;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px}
.weekly-section h3{font-size:.9rem;margin-bottom:10px;color:var(--text-bright)}
.weekly-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.82rem}
.weekly-bar-row .bar-label{min-width:70px;color:var(--text-dim)}
.weekly-bar-row .bar-track{flex:1;height:14px;background:var(--bg);border-radius:7px;overflow:hidden}
.weekly-bar-row .bar-fill{height:100%;border-radius:7px;transition:width .3s}
.weekly-bar-row .bar-val{min-width:36px;text-align:right;color:var(--text-dim);font-size:.75rem}
.weekly-trend{display:flex;gap:6px;align-items:flex-end;height:60px;margin:8px 0}
.weekly-trend .trend-bar{flex:1;border-radius:4px 4px 0 0;min-width:0;position:relative}
.weekly-trend .trend-label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:.6rem;color:var(--text-dim)}
.weekly-insight{font-size:.85rem;color:var(--text);padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.weekly-insight:last-child{border-bottom:none}
.weekly-insight .wi-label{color:var(--text-dim);font-size:.75rem;text-transform:uppercase;letter-spacing:.3px}

/* ── EDIT ANCHORS MODAL ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:flex-end;justify-content:center}
.modal{background:var(--card);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:500px;max-height:80dvh;overflow-y:auto;padding:20px 16px env(safe-area-inset-bottom,16px)}
.modal h3{margin-bottom:14px;font-size:1rem}
.modal-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.modal-item input[type=text]{flex:1;background:var(--bg);border:1px solid var(--card-border);border-radius:8px;padding:8px 12px;min-height:var(--tap)}
.modal-item .del-anchor{color:var(--red);padding:8px}
.modal-actions{display:flex;gap:8px;margin-top:14px}
.modal-actions button{flex:1;min-height:var(--tap);border-radius:10px;font-weight:600;font-size:.95rem}
.modal-actions .save{background:var(--accent);color:var(--bg)}
.modal-actions .cancel{border:1px solid var(--card-border)}
.add-link{font-size:.85rem;color:var(--accent);padding:8px 0;cursor:pointer}

/* ── GOOGLE TASKS ── */
.gt-signin{width:100%;min-height:var(--tap);border-radius:10px;background:var(--bg);border:1.5px solid var(--card-border);font-size:.9rem;color:var(--text);display:flex;align-items:center;justify-content:center;gap:8px;padding:10px}
.gt-signin:hover{border-color:var(--accent)}
.gt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.gt-header select{background:var(--bg);border:1px solid var(--card-border);border-radius:8px;padding:6px 10px;font-size:.85rem;color:var(--text);min-height:36px}
.gt-signout{font-size:.75rem;color:var(--text-dim);padding:4px 8px;border:1px solid var(--card-border);border-radius:6px}
.gt-task{display:flex;align-items:flex-start;gap:12px;min-height:var(--tap);padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.gt-task:last-child{border-bottom:none}
.gt-task .checkbox{margin-top:2px}
.gt-task.checked .checkbox{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.gt-task .gt-title{font-size:.95rem;flex:1;line-height:1.4}
.gt-task.checked .gt-title{color:var(--text-dim);text-decoration:line-through}
.gt-task .gt-due{font-size:.7rem;color:var(--text-dim);margin-top:2px}
.gt-add-row{display:flex;gap:8px;margin-top:10px}
.gt-add-row input{flex:1;background:var(--bg);border:1px solid var(--card-border);border-radius:8px;padding:8px 12px;min-height:var(--tap);font-size:.9rem}
.gt-add-row button{min-width:var(--tap);min-height:var(--tap);border-radius:8px;background:var(--accent);color:var(--bg);font-size:1.2rem;font-weight:700}
.gt-loading{text-align:center;padding:16px 0;color:var(--text-dim);font-size:.9rem}
.gt-error{text-align:center;padding:12px;background:rgba(232,93,93,.1);border-radius:8px;color:var(--red);font-size:.85rem;margin-bottom:8px}
.gt-setup{padding:8px 0;font-size:.85rem;color:var(--text-dim);line-height:1.5}
.gt-setup code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:.8rem;color:var(--accent)}
.gt-config-row{display:flex;gap:8px;margin-top:10px}
.gt-config-row input{flex:1;background:var(--bg);border:1px solid var(--card-border);border-radius:8px;padding:8px 12px;min-height:var(--tap);font-size:.8rem}
.gt-config-row button{min-height:var(--tap);padding:0 16px;border-radius:8px;background:var(--accent);color:var(--bg);font-weight:600;font-size:.85rem}
.gt-refresh{font-size:.75rem;color:var(--accent);padding:4px 8px}

/* ── SETTINGS MODAL ── */
.gear-btn{font-size:1.3rem;color:var(--text-dim);padding:4px 8px;transition:color .15s}
.gear-btn:hover{color:var(--accent)}
.settings-btn{width:100%;min-height:var(--tap);border-radius:10px;background:var(--bg);border:1.5px solid var(--card-border);font-size:.9rem;color:var(--text);display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;margin-bottom:10px;transition:border-color .15s}
.settings-btn:hover{border-color:var(--accent)}
.settings-btn.danger{border-color:var(--red);color:var(--red)}
.settings-btn.danger:hover{background:rgba(232,93,93,.1)}
.import-label{display:flex;width:100%;min-height:var(--tap);border-radius:10px;background:var(--bg);border:1.5px solid var(--card-border);font-size:.9rem;color:var(--text);align-items:center;justify-content:center;gap:8px;padding:10px;margin-bottom:10px;cursor:pointer;transition:border-color .15s}
.import-label:hover{border-color:var(--accent)}
.import-label input{display:none}

.hidden{display:none!important}
.view{display:none}
.view.active{display:block}
</style>
</head>
<body>

<!-- ════ TODAY VIEW ════ -->
<div id="todayView" class="view active">
  <div class="header">
    <h1>Today</h1>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="date" id="todayDate"></div>
      <button class="gear-btn" onclick="openSettings()" aria-label="Settings"><svg class="ic" viewBox="0 0 24 24" style="width:20px;height:20px"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 11-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 11-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 11-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 110-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 110 4h-.09a1.65 1.65 0 00-1.51 1z" fill="none" stroke="currentColor" stroke-width="2"/></svg></button>
    </div>
  </div>

  <div id="todayProgress"></div>

  <!-- Wake Up -->
  <div class="card" id="wakeCard">
    <div class="card-head wake-compact">
      <h2><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.9 4.9l2.1 2.1M17 17l2.1 2.1M4.9 19.1l2.1-2.1M17 7l2.1-2.1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Wake Up</h2>
      <input type="time" class="time-input wake-time-inline" id="wakeTime" onchange="saveWake()">
    </div>
  </div>

  <!-- Daily Anchors -->
  <div class="card" id="anchorsCard">
    <div class="card-head" onclick="toggleCard('anchorsCard')">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M9 11l3 3 8-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Daily Anchors</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="card-body">
      <div id="anchorsList"></div>
      <div class="add-link" onclick="openEditAnchors()">edit list</div>
    </div>
  </div>

  <!-- Google Tasks -->
  <div class="card" id="tasksCard">
    <div class="card-head" onclick="toggleCard('tasksCard')">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Google Tasks</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="card-body">
      <div id="gtContent"></div>
    </div>
  </div>

  <!-- Midday Check-in -->
  <div class="card" id="middayCard">
    <div class="card-head" onclick="toggleCard('middayCard')">
      <h2><svg class="ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Midday Check-in</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="card-body">
      <div class="field">
        <label>Top 3 Priorities</label>
        <div id="prioritiesList"></div>
      </div>
      <div class="field">
        <label>Energy Level</label>
        <div class="pills" id="energyPills">
          <button class="pill" onclick="pickEnergy('low')">Low</button>
          <button class="pill" onclick="pickEnergy('medium')">Medium</button>
          <button class="pill" onclick="pickEnergy('high')">High</button>
        </div>
      </div>
      <div class="field">
        <label>Biggest Time Waster</label>
        <input type="text" class="time-input" id="timeWaster" placeholder="What pulled you off track?" oninput="saveMiddayText()" style="width:100%;box-sizing:border-box">
      </div>
      <div class="field">
        <label>Intention Reset</label>
        <input type="text" class="time-input" id="intentionReset" placeholder="What am I focusing on now?" oninput="saveMiddayText()" style="width:100%;box-sizing:border-box">
      </div>
      <div class="field">
        <label>Gratitude / Win</label>
        <input type="text" class="time-input" id="gratitudeWin" placeholder="One thing that went well today" oninput="saveMiddayText()" style="width:100%;box-sizing:border-box">
      </div>
      <div class="field">
        <label>Unproductive Screen Time</label>
        <div class="pills" id="screenTimePills">
          <button class="pill" onclick="pickScreenTime('0')">0h</button>
          <button class="pill" onclick="pickScreenTime('1')">1h</button>
          <button class="pill" onclick="pickScreenTime('2')">2h</button>
          <button class="pill" onclick="pickScreenTime('3')">3h</button>
          <button class="pill" onclick="pickScreenTime('4+')">4+h</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bedtime Productivity -->
  <div class="card" id="bedtimeCard">
    <div class="card-head" onclick="toggleCard('bedtimeCard')">
      <h2><svg class="ic" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Bedtime Productivity</h2>
      <span class="chevron">&#9660;</span>
    </div>
    <div class="card-body">
      <div id="bedtimeChecklist"></div>
      <div class="add-link" onclick="openEditBedtime()">edit list</div>
    </div>
  </div>
</div>

<!-- ════ EDIT BEDTIME CHECKLIST MODAL ════ -->
<div id="editBedtimeModal" class="modal-overlay hidden" onclick="if(event.target===this)closeEditBedtime()">
  <div class="modal">
    <h3>Edit Bedtime Checklist</h3>
    <div id="editBedtimeList"></div>
    <div class="add-link" id="addBedtimeBtn" onclick="addBedtimeField()">+ Add item</div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeEditBedtime()">Cancel</button>
      <button class="save" onclick="saveBedtimeEdit()">Save</button>
    </div>
  </div>
</div>

<!-- ════ HISTORY VIEW ════ -->
<div id="historyView" class="view">
  <div class="header">
    <h1>History</h1>
  </div>
  <div class="streaks" id="streaksArea"></div>
  <div class="date-strip" id="dateStrip"></div>
  <div id="historySummary"></div>
</div>

<!-- ════ WEEKLY REVIEW VIEW ════ -->
<div id="weeklyView" class="view">
  <div class="header">
    <h1>Weekly Review</h1>
  </div>
  <div id="weeklyContent"></div>
</div>

<!-- ════ BOTTOM NAV ════ -->
<nav class="nav">
  <button class="active" id="navToday" onclick="switchView('today')">
    <svg class="nav-ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Today
  </button>
  <button id="navHistory" onclick="switchView('history')">
    <svg class="nav-ic" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>History
  </button>
  <button id="navWeekly" onclick="switchView('weekly')">
    <svg class="nav-ic" viewBox="0 0 24 24"><path d="M4 20V10M10 20V4M16 20v-8M22 20v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>Weekly
  </button>
</nav>

<!-- ════ EDIT ANCHORS MODAL ════ -->
<div id="editModal" class="modal-overlay hidden" onclick="if(event.target===this)closeEditAnchors()">
  <div class="modal">
    <h3>Edit Daily Anchors</h3>
    <div id="editAnchorsList"></div>
    <div class="add-link" id="addAnchorBtn" onclick="addAnchorField()">+ Add item</div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeEditAnchors()">Cancel</button>
      <button class="save" onclick="saveAnchorsEdit()">Save</button>
    </div>
  </div>
</div>


<!-- ════ SETTINGS MODAL ════ -->
<div id="settingsModal" class="modal-overlay hidden" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <h3>Settings</h3>
    <button class="settings-btn" onclick="exportData()">Export Data</button>
    <label class="import-label">
      Import Data
      <input type="file" accept=".json,application/json" onchange="importData(event)">
    </label>
    <div style="font-size:.75rem;color:var(--text-dim);margin-bottom:14px;line-height:1.5">
      Export saves all your data as a JSON file.<br>Import replaces all current data.
    </div>
    <div style="border-top:1px solid var(--card-border);margin:14px 0;padding-top:14px">
      <h3 style="font-size:.95rem;margin-bottom:12px">Bedtime Reminder</h3>
      <div class="field">
        <label>Bedtime</label>
        <input type="time" class="time-input" id="bedtimeTime" value="22:30" onchange="saveBedtimeTime()">
      </div>
      <div class="field">
        <label>Remind me</label>
        <div class="pills" id="bedtimeOffsetPills">
          <button class="pill active" onclick="setBedtimeOffset(0)">At bedtime</button>
          <button class="pill" onclick="setBedtimeOffset(15)">15 min before</button>
          <button class="pill" onclick="setBedtimeOffset(30)">30 min before</button>
        </div>
      </div>
      <div class="field">
        <label>ntfy topic</label>
        <input type="text" class="time-input" id="bedtimeNtfyTopic" placeholder="e.g. my-bedtime" oninput="saveBedtimeNtfyTopic()" style="width:100%;box-sizing:border-box">
      </div>
      <div id="bedtimeSetupGuide"></div>
    </div>
    <div style="border-top:1px solid var(--card-border);margin:14px 0;padding-top:14px">
      <h3 style="font-size:.95rem;margin-bottom:12px">Afternoon Reset Reminder</h3>
      <div class="field">
        <label>Reminder time</label>
        <input type="time" class="time-input" id="afternoonTime" value="14:00" onchange="saveAfternoonTime()">
      </div>
      <div id="afternoonSetupGuide"></div>
    </div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeSettings()">Close</button>
    </div>
  </div>
</div>

<script>
// ── State ──
const STORAGE_KEY = 'daytracker';
const DEFAULT_ANCHORS = ['Made bed','Shower','Left the house','Ate a real meal','Read something','In bed by target time'];

let state = loadState();
let currentHistoryDate = null;

function todayKey() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return { settings: { anchors: [...DEFAULT_ANCHORS] }, days: {} };
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function getDay(key) {
  if (!key) key = todayKey();
  if (!state.days[key]) {
    state.days[key] = {
      wake: { time: '' },
      anchors: {},
      midday: { priorities: [{text:'',done:false},{text:'',done:false},{text:'',done:false}], energy: '', timeWaster: '', intention: '', gratitude: '', screenTime: '' }
    };
  }
  return state.days[key];
}

// ── View switching ──
function switchView(v) {
  document.getElementById('todayView').classList.toggle('active', v === 'today');
  document.getElementById('historyView').classList.toggle('active', v === 'history');
  document.getElementById('weeklyView').classList.toggle('active', v === 'weekly');
  document.getElementById('navToday').classList.toggle('active', v === 'today');
  document.getElementById('navHistory').classList.toggle('active', v === 'history');
  document.getElementById('navWeekly').classList.toggle('active', v === 'weekly');
  if (v === 'history') renderHistory();
  if (v === 'weekly') renderWeekly();
}

// ── Card collapse ──
function toggleCard(id) {
  document.getElementById(id).classList.toggle('collapsed');
}

// ── Helpers ──
function hhmm(date) {
  if (typeof date === 'string' && date.includes(':')) return date;
  const d = date instanceof Date ? date : new Date(date);
  return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
}

// ══════════════════════
//  WAKE UP
// ══════════════════════
const DEFAULT_BEDTIME = ['Brushed teeth', 'No screens 30 min', 'Read', 'Stretched', 'Journaled'];

function getBedtimeItems() {
  if (!state.settings.bedtimeItems) state.settings.bedtimeItems = [...DEFAULT_BEDTIME];
  return state.settings.bedtimeItems;
}

function renderWake() {
  const day = getDay();
  const el = document.getElementById('wakeTime');
  if (day.wake.time) {
    el.value = day.wake.time;
  } else {
    el.value = hhmm(new Date());
    day.wake.time = el.value;
    save();
  }
}

function saveWake() {
  getDay().wake.time = document.getElementById('wakeTime').value;
  save();
}

// ══════════════════════
//  DAILY ANCHORS
// ══════════════════════
function renderAnchors() {
  const day = getDay();
  const anchors = state.settings.anchors || DEFAULT_ANCHORS;
  const list = document.getElementById('anchorsList');
  list.innerHTML = '';
  anchors.forEach(a => {
    const checked = day.anchors[a] || false;
    const row = document.createElement('div');
    row.className = 'check-row' + (checked ? ' checked' : '');
    row.innerHTML = '<div class="checkbox">' + (checked ? '&#10003;' : '') + '</div><div class="label">' + esc(a) + '</div>';
    row.onclick = () => {
      day.anchors[a] = !day.anchors[a];
      save();
      renderAnchors();
    };
    list.appendChild(row);
  });
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Edit anchors modal
function openEditAnchors() {
  document.getElementById('editModal').classList.remove('hidden');
  renderEditAnchors();
}
function closeEditAnchors() {
  document.getElementById('editModal').classList.add('hidden');
}
function renderEditAnchors() {
  const list = document.getElementById('editAnchorsList');
  const anchors = state.settings.anchors || DEFAULT_ANCHORS;
  list.innerHTML = '';
  anchors.forEach((a, i) => {
    const row = document.createElement('div');
    row.className = 'modal-item';
    row.innerHTML = '<input type="text" value="' + esc(a).replace(/"/g, '&quot;') + '" data-idx="' + i + '">'
      + '<button class="del-anchor" onclick="removeAnchorField(' + i + ')">&#10005;</button>';
    list.appendChild(row);
  });
  document.getElementById('addAnchorBtn').classList.toggle('hidden', anchors.length >= 10);
}
function addAnchorField() {
  if (state.settings.anchors.length >= 10) return;
  state.settings.anchors.push('');
  renderEditAnchors();
  const inputs = document.querySelectorAll('#editAnchorsList input');
  if (inputs.length) inputs[inputs.length - 1].focus();
}
function removeAnchorField(i) {
  state.settings.anchors.splice(i, 1);
  renderEditAnchors();
}
function saveAnchorsEdit() {
  const inputs = document.querySelectorAll('#editAnchorsList input');
  const newAnchors = [];
  inputs.forEach(inp => {
    const v = inp.value.trim();
    if (v) newAnchors.push(v);
  });
  state.settings.anchors = newAnchors.length ? newAnchors : [...DEFAULT_ANCHORS];
  save();
  closeEditAnchors();
  renderAnchors();
}

// ══════════════════════
//  MIDDAY CHECK-IN
// ══════════════════════
function getMidday() {
  const day = getDay();
  if (!day.midday) {
    day.midday = { priorities: [{text:'',done:false},{text:'',done:false},{text:'',done:false}], energy: '', timeWaster: '', intention: '', gratitude: '', screenTime: '' };
  }
  if (!day.midday.priorities || day.midday.priorities.length < 3) {
    day.midday.priorities = [{text:'',done:false},{text:'',done:false},{text:'',done:false}];
  }
  if (day.midday.screenTime === undefined) day.midday.screenTime = '';
  return day.midday;
}

function renderMidday() {
  const m = getMidday();
  // Priorities
  const list = document.getElementById('prioritiesList');
  list.innerHTML = '';
  m.priorities.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'priority-row' + (p.done ? ' checked' : '');
    row.innerHTML = '<div class="checkbox" onclick="togglePriority(' + i + ')">' + (p.done ? '&#10003;' : '') + '</div>'
      + '<input type="text" value="' + esc(p.text).replace(/"/g, '&quot;') + '" placeholder="Priority ' + (i+1) + '" oninput="savePriorityText(' + i + ',this.value)">';
    list.appendChild(row);
  });
  // Energy pills
  const pills = document.getElementById('energyPills').querySelectorAll('.pill');
  pills[0].classList.toggle('active', m.energy === 'low');
  pills[1].classList.toggle('active', m.energy === 'medium');
  pills[2].classList.toggle('active', m.energy === 'high');
  // Text fields
  document.getElementById('timeWaster').value = m.timeWaster || '';
  document.getElementById('intentionReset').value = m.intention || '';
  document.getElementById('gratitudeWin').value = m.gratitude || '';
  // Screen time pills
  const stPills = document.getElementById('screenTimePills').querySelectorAll('.pill');
  ['0','1','2','3','4+'].forEach((v, i) => stPills[i].classList.toggle('active', m.screenTime === v));
}

function togglePriority(i) {
  const m = getMidday();
  m.priorities[i].done = !m.priorities[i].done;
  save();
  renderMidday();
}

function savePriorityText(i, val) {
  getMidday().priorities[i].text = val;
  save();
}

function pickEnergy(v) {
  getMidday().energy = v;
  save();
  renderMidday();
}

function pickScreenTime(v) {
  getMidday().screenTime = v;
  save();
  renderMidday();
}

function saveMiddayText() {
  const m = getMidday();
  m.timeWaster = document.getElementById('timeWaster').value;
  m.intention = document.getElementById('intentionReset').value;
  m.gratitude = document.getElementById('gratitudeWin').value;
  save();
}

// ══════════════════════
//  BEDTIME PRODUCTIVITY
// ══════════════════════
function renderBedtime() {
  const day = getDay();
  if (!day.wake.bedtimeChecklist) day.wake.bedtimeChecklist = {};
  const items = getBedtimeItems();
  const list = document.getElementById('bedtimeChecklist');
  list.innerHTML = '';
  items.forEach(item => {
    const checked = day.wake.bedtimeChecklist[item] || false;
    const row = document.createElement('div');
    row.className = 'check-row' + (checked ? ' checked' : '');
    row.innerHTML = '<div class="checkbox">' + (checked ? '&#10003;' : '') + '</div><div class="label">' + esc(item) + '</div>';
    row.onclick = () => {
      day.wake.bedtimeChecklist[item] = !day.wake.bedtimeChecklist[item];
      save();
      renderBedtime();
    };
    list.appendChild(row);
  });
}

// Edit bedtime checklist modal
function openEditBedtime() {
  document.getElementById('editBedtimeModal').classList.remove('hidden');
  renderEditBedtime();
}
function closeEditBedtime() {
  document.getElementById('editBedtimeModal').classList.add('hidden');
}
function renderEditBedtime() {
  const list = document.getElementById('editBedtimeList');
  const items = getBedtimeItems();
  list.innerHTML = '';
  items.forEach((a, i) => {
    const row = document.createElement('div');
    row.className = 'modal-item';
    row.innerHTML = '<input type="text" value="' + esc(a).replace(/"/g, '&quot;') + '" data-idx="' + i + '">'
      + '<button class="del-anchor" onclick="removeBedtimeField(' + i + ')">&#10005;</button>';
    list.appendChild(row);
  });
  document.getElementById('addBedtimeBtn').classList.toggle('hidden', items.length >= 10);
}
function addBedtimeField() {
  const items = getBedtimeItems();
  if (items.length >= 10) return;
  items.push('');
  renderEditBedtime();
  const inputs = document.querySelectorAll('#editBedtimeList input');
  if (inputs.length) inputs[inputs.length - 1].focus();
}
function removeBedtimeField(i) {
  getBedtimeItems().splice(i, 1);
  renderEditBedtime();
}
function saveBedtimeEdit() {
  const inputs = document.querySelectorAll('#editBedtimeList input');
  const newItems = [];
  inputs.forEach(inp => {
    const v = inp.value.trim();
    if (v) newItems.push(v);
  });
  state.settings.bedtimeItems = newItems.length ? newItems : [...DEFAULT_BEDTIME];
  save();
  closeEditBedtime();
  renderBedtime();
}

// ══════════════════════
//  HISTORY
// ══════════════════════
function renderHistory() {
  renderStreaks();
  renderDateStrip();
  renderDaySummary();
}

function calcStreak(testFn) {
  let streak = 0;
  let cursor = new Date();
  while (true) {
    const k = cursor.getFullYear() + '-' + String(cursor.getMonth()+1).padStart(2,'0') + '-' + String(cursor.getDate()).padStart(2,'0');
    if (testFn(k)) { streak++; cursor.setDate(cursor.getDate() - 1); }
    else break;
  }
  // Find previous streak (skip the gap, count the next run)
  let prevStreak = 0;
  if (streak === 0) {
    cursor.setDate(cursor.getDate() - 1); // skip the missed day
    while (true) {
      const k = cursor.getFullYear() + '-' + String(cursor.getMonth()+1).padStart(2,'0') + '-' + String(cursor.getDate()).padStart(2,'0');
      if (testFn(k)) { prevStreak++; cursor.setDate(cursor.getDate() - 1); }
      else break;
    }
  }
  // Count hits in last 14 days
  let hits = 0;
  const now = new Date();
  for (let i = 0; i < 14; i++) {
    const c = new Date(now);
    c.setDate(c.getDate() - i);
    const k = c.getFullYear() + '-' + String(c.getMonth()+1).padStart(2,'0') + '-' + String(c.getDate()).padStart(2,'0');
    if (testFn(k)) hits++;
  }
  return { streak, prevStreak, hits14: hits };
}

function streakBox(num, label, recovery) {
  let html = '<div class="streak-box"><div class="num">' + num + '</div><div class="lbl">' + label + '</div>';
  if (recovery) html += '<div class="streak-recovery">' + recovery + '</div>';
  html += '</div>';
  return html;
}

function streakRecoveryMsg(info) {
  if (info.streak > 0 || info.prevStreak === 0) return '';
  const pct = Math.round(info.hits14 / 14 * 100);
  return 'Had a ' + info.prevStreak + '-day streak. You hit ' + info.hits14 + ' of 14 days (' + pct + '%). Pick it back up!';
}

function renderStreaks() {
  const days = Object.keys(state.days).sort();
  const total = days.length;
  const anchorList = state.settings.anchors || DEFAULT_ANCHORS;
  const btItems = getBedtimeItems();

  const anchorInfo = calcStreak(k => {
    const d = state.days[k];
    return d && d.anchors && anchorList.every(a => d.anchors[a]);
  });
  const btInfo = calcStreak(k => {
    const d = state.days[k];
    return d && d.wake && d.wake.bedtimeChecklist && btItems.every(item => d.wake.bedtimeChecklist[item]);
  });

  document.getElementById('streaksArea').innerHTML =
    streakBox(total, 'Days tracked', '')
    + streakBox(anchorInfo.streak, 'Anchors streak', streakRecoveryMsg(anchorInfo))
    + streakBox(btInfo.streak, 'Bedtime streak', streakRecoveryMsg(btInfo));
}

function dayCompleteness(k) {
  const d = state.days[k];
  if (!d) return 'gray';
  let filled = 0, total = 0;
  // wake
  total++; if (d.wake && d.wake.time) filled++;
  // anchors
  const anchors = state.settings.anchors || DEFAULT_ANCHORS;
  total++; if (d.anchors && anchors.some(a => d.anchors[a])) filled++;
  // midday
  total++; if (d.midday && d.midday.priorities && d.midday.priorities.some(p => p.done)) filled++;
  // bedtime
  const btItems = getBedtimeItems();
  total++; if (d.wake && d.wake.bedtimeChecklist && btItems.some(item => d.wake.bedtimeChecklist[item])) filled++;
  if (filled === total) return 'green';
  if (filled > 0) return 'yellow';
  return 'gray';
}

function renderDateStrip() {
  const strip = document.getElementById('dateStrip');
  strip.innerHTML = '';
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const today = new Date();
  if (!currentHistoryDate) currentHistoryDate = todayKey();

  for (let i = 13; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const k = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    const color = dayCompleteness(k);
    const sel = k === currentHistoryDate ? ' sel' : '';
    const dot = document.createElement('div');
    dot.className = 'date-dot' + sel;
    dot.innerHTML = '<span class="day">' + dayNames[d.getDay()] + '</span><span class="num">' + d.getDate() + '</span><span class="dot dot-' + color + '"></span>';
    dot.onclick = () => { currentHistoryDate = k; renderDateStrip(); renderDaySummary(); };
    strip.appendChild(dot);
  }
  // scroll to end
  strip.scrollLeft = strip.scrollWidth;
}

function renderDaySummary() {
  const el = document.getElementById('historySummary');
  const k = currentHistoryDate || todayKey();
  const d = state.days[k];
  if (!d) {
    el.innerHTML = '<div class="history-summary"><h3>' + k + '</h3><div style="color:var(--text-dim);padding:12px 0">No data for this day.</div></div>';
    return;
  }
  let rows = '';
  // Wake
  if (d.wake && d.wake.time) {
    rows += row('Wake time', d.wake.time);
  }
  if (d.wake && d.wake.bedtimeChecklist) {
    const btDone = getBedtimeItems().filter(item => d.wake.bedtimeChecklist[item]);
    if (btDone.length) rows += row('Bedtime', btDone.length + '/' + getBedtimeItems().length + ' — ' + btDone.join(', '));
  }
  // Anchors
  const anchors = state.settings.anchors || DEFAULT_ANCHORS;
  const done = anchors.filter(a => d.anchors && d.anchors[a]);
  if (done.length) rows += row('Anchors', done.length + '/' + anchors.length + ' — ' + done.join(', '));
  // Midday
  if (d.midday) {
    const prDone = (d.midday.priorities || []).filter(p => p.done && p.text);
    if (prDone.length) rows += row('Priorities', prDone.map(p => p.text).join(', '));
    if (d.midday.energy) rows += row('Energy', d.midday.energy);
    if (d.midday.timeWaster) rows += row('Time waster', esc(d.midday.timeWaster));
    if (d.midday.intention) rows += row('Intention', esc(d.midday.intention));
    if (d.midday.gratitude) rows += row('Gratitude', esc(d.midday.gratitude));
    if (d.midday.screenTime) rows += row('Screen time', d.midday.screenTime + 'h unproductive');
  }
  if (!rows) rows = '<div style="color:var(--text-dim);padding:12px 0">No data for this day.</div>';

  el.innerHTML = '<div class="history-summary"><h3>' + k + '</h3>' + rows + '</div>';
}

function row(k, v) {
  return '<div class="summary-row"><span class="k">' + k + '</span><span>' + v + '</span></div>';
}

// ══════════════════════
//  WEEKLY REVIEW
// ══════════════════════
function getWeekKeys() {
  const keys = [];
  const today = new Date();
  for (let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    keys.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'));
  }
  return keys;
}

function renderWeekly() {
  const keys = getWeekKeys();
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const el = document.getElementById('weeklyContent');
  let html = '';

  // Gather data
  const anchorList = state.settings.anchors || DEFAULT_ANCHORS;
  const btItems = getBedtimeItems();
  const energyMap = { low: 1, medium: 2, high: 3 };
  const screenMap = { '0': 0, '1': 1, '2': 2, '3': 3, '4+': 4 };

  let anchorTotals = 0, anchorDone = 0;
  let btTotals = 0, btDone = 0;
  let priTotals = 0, priDone = 0;
  const energies = [];
  const screenTimes = [];
  const wasters = {};
  let bestDay = null, bestScore = -1, worstDay = null, worstScore = 999;

  keys.forEach(k => {
    const d = state.days[k];
    if (!d) return;
    let score = 0, possible = 0;

    // Anchors
    anchorList.forEach(a => {
      anchorTotals++;
      if (d.anchors && d.anchors[a]) { anchorDone++; score++; }
      possible++;
    });

    // Bedtime
    btItems.forEach(item => {
      btTotals++;
      if (d.wake && d.wake.bedtimeChecklist && d.wake.bedtimeChecklist[item]) { btDone++; score++; }
      possible++;
    });

    // Priorities
    if (d.midday && d.midday.priorities) {
      d.midday.priorities.forEach(p => {
        if (p.text) { priTotals++; if (p.done) { priDone++; score++; } possible++; }
      });
    }

    // Energy
    if (d.midday && d.midday.energy && energyMap[d.midday.energy]) {
      energies.push({ key: k, val: energyMap[d.midday.energy] });
    }

    // Screen time
    if (d.midday && d.midday.screenTime !== undefined && d.midday.screenTime !== '') {
      screenTimes.push(screenMap[d.midday.screenTime] || 0);
    }

    // Time wasters
    if (d.midday && d.midday.timeWaster) {
      const w = d.midday.timeWaster.trim().toLowerCase();
      if (w) wasters[w] = (wasters[w] || 0) + 1;
    }

    // Best/worst
    const pct = possible > 0 ? score / possible : 0;
    if (pct > bestScore) { bestScore = pct; bestDay = k; }
    if (pct < worstScore) { worstScore = pct; worstDay = k; }
  });

  // ── Energy trend ──
  html += '<div class="weekly-section"><h3>Energy Trend</h3>';
  if (energies.length === 0) {
    html += '<div style="color:var(--text-dim);font-size:.85rem">No energy data this week.</div>';
  } else {
    html += '<div class="weekly-trend">';
    keys.forEach(k => {
      const dt = new Date(k + 'T00:00:00');
      const label = dayNames[dt.getDay()];
      const e = energies.find(x => x.key === k);
      const h = e ? (e.val / 3 * 100) : 0;
      const colors = { 1: 'var(--red)', 2: 'var(--amber)', 3: 'var(--green)' };
      const bg = e ? colors[e.val] : '#333';
      html += '<div class="trend-bar" style="height:' + Math.max(h, 8) + '%;background:' + bg + '"><span class="trend-label">' + label + '</span></div>';
    });
    html += '</div><div style="height:18px"></div>';
  }
  html += '</div>';

  // ── Completion rates ──
  html += '<div class="weekly-section"><h3>Completion Rates</h3>';
  const anchorPct = anchorTotals ? Math.round(anchorDone / anchorTotals * 100) : 0;
  const btPct = btTotals ? Math.round(btDone / btTotals * 100) : 0;
  const priPct = priTotals ? Math.round(priDone / priTotals * 100) : 0;

  function barRow(label, pct, color) {
    return '<div class="weekly-bar-row"><span class="bar-label">' + label + '</span>'
      + '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>'
      + '<span class="bar-val">' + pct + '%</span></div>';
  }
  html += barRow('Anchors', anchorPct, 'var(--accent)');
  html += barRow('Bedtime', btPct, 'var(--green)');
  html += barRow('Priorities', priPct, 'var(--amber)');
  html += '</div>';

  // ── Screen time ──
  if (screenTimes.length) {
    const avg = (screenTimes.reduce((a, b) => a + b, 0) / screenTimes.length).toFixed(1);
    html += '<div class="weekly-section"><h3>Avg Unproductive Screen Time</h3>';
    html += '<div style="font-size:1.8rem;font-weight:700;color:' + (avg >= 3 ? 'var(--red)' : avg >= 2 ? 'var(--amber)' : 'var(--green)') + '">' + avg + 'h</div>';
    html += '<div style="font-size:.75rem;color:var(--text-dim)">per day this week</div></div>';
  }

  // ── Common time wasters ──
  const sortedWasters = Object.entries(wasters).sort((a, b) => b[1] - a[1]).slice(0, 3);
  if (sortedWasters.length) {
    html += '<div class="weekly-section"><h3>Common Time Wasters</h3>';
    sortedWasters.forEach(([w, count]) => {
      html += '<div class="weekly-insight"><div class="wi-label">' + count + 'x this week</div>' + esc(w) + '</div>';
    });
    html += '</div>';
  }

  // ── Best / Worst day ──
  html += '<div class="weekly-section"><h3>Best &amp; Worst Days</h3>';
  if (bestDay) {
    const bd = new Date(bestDay + 'T00:00:00');
    html += '<div class="weekly-insight"><div class="wi-label">Best day</div>' + dayNames[bd.getDay()] + ' ' + bd.getDate() + ' — ' + Math.round(bestScore * 100) + '% complete</div>';
  }
  if (worstDay && worstDay !== bestDay) {
    const wd = new Date(worstDay + 'T00:00:00');
    html += '<div class="weekly-insight"><div class="wi-label">Worst day</div>' + dayNames[wd.getDay()] + ' ' + wd.getDate() + ' — ' + Math.round(worstScore * 100) + '% complete</div>';
  }
  html += '</div>';

  el.innerHTML = html;
}

// ══════════════════════
//  MIDNIGHT ROLLOVER
// ══════════════════════
let lastKey = todayKey();
function checkMidnight() {
  const k = todayKey();
  if (k !== lastKey) {
    lastKey = k;
    renderAll();
  }
}
setInterval(checkMidnight, 30000);

// ══════════════════════
//  GOOGLE TASKS
// ══════════════════════
let gtToken = null;
let gtTokenClient = null;
let gtTaskLists = [];
let gtTasks = [];
let gtLoading = false;
let gtHideCompleted = true;

function getGtClientId() {
  return (state.settings && state.settings.gtClientId) || '';
}
function getGtListId() {
  return (state.settings && state.settings.gtListId) || '';
}

function renderGoogleTasks() {
  const el = document.getElementById('gtContent');
  const clientId = getGtClientId();

  // No client ID configured — show setup
  if (!clientId) {
    el.innerHTML = '<div class="gt-setup">'
      + 'To sync Google Tasks, you need a Google Cloud Client ID.'
      + '<br><br>1. Go to <strong>console.cloud.google.com</strong>'
      + '<br>2. Create a project &amp; enable the <strong>Google Tasks API</strong>'
      + '<br>3. Create <strong>OAuth 2.0 credentials</strong> (Web app)'
      + '<br>4. Add <code>https://wft2004.github.io</code> as authorized JS origin'
      + '<br>5. Paste the Client ID below'
      + '</div>'
      + '<div class="gt-config-row">'
      + '<input type="text" id="gtClientIdInput" placeholder="Client ID (ends in .apps.googleusercontent.com)">'
      + '<button onclick="saveGtClientId()">Save</button>'
      + '</div>';
    return;
  }

  // Loading
  if (gtLoading) {
    el.innerHTML = '<div class="gt-loading">Loading tasks...</div>';
    return;
  }

  // Not signed in
  if (!gtToken) {
    el.innerHTML = '<button class="gt-signin" onclick="gtSignInInteractive()">Sign in with Google</button>'
      + '<div style="text-align:center;margin-top:8px"><button class="gt-signout" onclick="clearGtClientId()">change Client ID</button></div>';
    return;
  }

  // Signed in — render tasks
  let html = '<div class="gt-header">'
    + '<select id="gtListSelect" onchange="gtSwitchList(this.value)">';
  gtTaskLists.forEach(l => {
    html += '<option value="' + l.id + '"' + (l.id === getGtListId() ? ' selected' : '') + '>' + esc(l.title) + '</option>';
  });
  html += '</select>'
    + '<span><button class="gt-refresh" onclick="gtFetchTasks()">refresh</button>'
    + '<button class="gt-signout" onclick="gtSignOut()">sign out</button></span></div>';

  // Task items
  const incomplete = gtTasks.filter(t => t.status !== 'completed');
  const completed = gtTasks.filter(t => t.status === 'completed');
  const visible = gtHideCompleted ? incomplete : [...incomplete, ...completed];

  if (visible.length === 0 && incomplete.length === 0) {
    html += '<div style="color:var(--text-dim);padding:12px 0;text-align:center">' + (gtHideCompleted && completed.length ? 'All tasks completed!' : 'No tasks in this list.') + '</div>';
  }
  visible.forEach(t => {
    const done = t.status === 'completed';
    const dueStr = t.due ? '<div class="gt-due">Due ' + t.due.substring(0, 10) + '</div>' : '';
    html += '<div class="gt-task' + (done ? ' checked' : '') + '" onclick="gtToggleTask(\'' + t.id + '\')">'
      + '<div class="checkbox">' + (done ? '&#10003;' : '') + '</div>'
      + '<div><div class="gt-title">' + esc(t.title) + '</div>' + dueStr + '</div></div>';
  });

  // Toggle completed visibility
  if (completed.length) {
    html += '<div style="text-align:center;padding-top:8px"><button class="gt-refresh" onclick="gtToggleHideCompleted()">'
      + (gtHideCompleted ? 'Show ' + completed.length + ' completed' : 'Hide completed') + '</button></div>';
  }

  // Add task
  html += '<div class="gt-add-row">'
    + '<input type="text" id="gtNewTask" placeholder="Add a task..." onkeydown="if(event.key===\'Enter\')gtAddTask()">'
    + '<button onclick="gtAddTask()">+</button></div>';

  el.innerHTML = html;
}

function gtToggleHideCompleted() {
  gtHideCompleted = !gtHideCompleted;
  renderGoogleTasks();
}

function saveGtClientId() {
  const v = document.getElementById('gtClientIdInput').value.trim();
  if (!v) return;
  if (!state.settings) state.settings = {};
  state.settings.gtClientId = v;
  save();
  gtInitTokenClient();
  renderGoogleTasks();
}

function clearGtClientId() {
  if (!state.settings) return;
  delete state.settings.gtClientId;
  delete state.settings.gtListId;
  gtToken = null;
  gtTaskLists = [];
  gtTasks = [];
  save();
  renderGoogleTasks();
}

function gtSaveToken(token, expiresIn) {
  localStorage.setItem('gt_token', token);
  localStorage.setItem('gt_token_exp', String(Date.now() + (expiresIn - 60) * 1000));
}
function gtLoadToken() {
  const token = localStorage.getItem('gt_token');
  const exp = Number(localStorage.getItem('gt_token_exp') || 0);
  if (token && Date.now() < exp) return token;
  localStorage.removeItem('gt_token');
  localStorage.removeItem('gt_token_exp');
  return null;
}
function gtClearToken() {
  localStorage.removeItem('gt_token');
  localStorage.removeItem('gt_token_exp');
}

function gtInitTokenClient() {
  const clientId = getGtClientId();
  if (!clientId || typeof google === 'undefined') return;
  gtTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: 'https://www.googleapis.com/auth/tasks',
    callback: (resp) => {
      if (resp.error) {
        gtLoading = false;
        renderGoogleTasks();
        return;
      }
      gtToken = resp.access_token;
      gtSaveToken(resp.access_token, resp.expires_in || 3600);
      gtFetchLists();
    }
  });
}

function gtSignIn() {
  if (!gtTokenClient) gtInitTokenClient();
  if (!gtTokenClient) return;
  gtLoading = true;
  renderGoogleTasks();
  gtTokenClient.requestAccessToken({ prompt: '' });
}

function gtSignInInteractive() {
  if (!gtTokenClient) gtInitTokenClient();
  if (!gtTokenClient) return;
  gtLoading = true;
  renderGoogleTasks();
  gtTokenClient.requestAccessToken({ prompt: 'consent' });
}

function gtSignOut() {
  if (gtToken) {
    google.accounts.oauth2.revoke(gtToken);
  }
  gtToken = null;
  gtClearToken();
  gtTaskLists = [];
  gtTasks = [];
  renderGoogleTasks();
}

function gtTryRestore() {
  const saved = gtLoadToken();
  if (saved) {
    gtToken = saved;
    gtFetchLists();
    return;
  }
  // No saved token — try silent re-auth if user previously signed in
  if (getGtClientId() && gtTokenClient) {
    gtTokenClient.requestAccessToken({ prompt: '' });
  }
}

async function gtApi(url, options) {
  const resp = await fetch(url, {
    ...options,
    headers: { 'Authorization': 'Bearer ' + gtToken, 'Content-Type': 'application/json', ...(options && options.headers) }
  });
  if (resp.status === 401) {
    gtToken = null;
    gtClearToken();
    gtLoading = false;
    renderGoogleTasks();
    return null;
  }
  if (!resp.ok) return null;
  if (resp.status === 204) return {};
  return resp.json();
}

async function gtFetchLists() {
  gtLoading = true;
  renderGoogleTasks();
  const data = await gtApi('https://tasks.googleapis.com/tasks/v1/users/@me/lists');
  gtLoading = false;
  if (!data) { renderGoogleTasks(); return; }
  gtTaskLists = data.items || [];
  // Select saved list or default to first
  if (!getGtListId() && gtTaskLists.length) {
    if (!state.settings) state.settings = {};
    state.settings.gtListId = gtTaskLists[0].id;
    save();
  }
  await gtFetchTasks();
}

async function gtFetchTasks() {
  const listId = getGtListId();
  if (!listId || !gtToken) return;
  gtLoading = true;
  renderGoogleTasks();
  const data = await gtApi('https://tasks.googleapis.com/tasks/v1/lists/' + encodeURIComponent(listId) + '/tasks?maxResults=100&showCompleted=true&showHidden=true');
  gtLoading = false;
  if (!data) { renderGoogleTasks(); return; }
  gtTasks = (data.items || []).filter(t => t.title);
  renderGoogleTasks();
}

function gtSwitchList(listId) {
  if (!state.settings) state.settings = {};
  state.settings.gtListId = listId;
  save();
  gtFetchTasks();
}

async function gtToggleTask(taskId) {
  const listId = getGtListId();
  const task = gtTasks.find(t => t.id === taskId);
  if (!task || !listId) return;
  const newStatus = task.status === 'completed' ? 'needsAction' : 'completed';
  // Optimistic UI update
  task.status = newStatus;
  if (newStatus === 'completed') task.completed = new Date().toISOString();
  else delete task.completed;
  renderGoogleTasks();
  // API call
  const body = { status: newStatus };
  if (newStatus === 'completed') body.completed = task.completed;
  else body.completed = null;
  await gtApi('https://tasks.googleapis.com/tasks/v1/lists/' + encodeURIComponent(listId) + '/tasks/' + encodeURIComponent(taskId), {
    method: 'PATCH',
    body: JSON.stringify(body)
  });
}

async function gtAddTask() {
  const input = document.getElementById('gtNewTask');
  const title = input.value.trim();
  if (!title) return;
  const listId = getGtListId();
  if (!listId || !gtToken) return;
  input.value = '';
  const data = await gtApi('https://tasks.googleapis.com/tasks/v1/lists/' + encodeURIComponent(listId) + '/tasks', {
    method: 'POST',
    body: JSON.stringify({ title: title, status: 'needsAction' })
  });
  if (data) {
    gtTasks.unshift(data);
    renderGoogleTasks();
  }
}

// Init token client when GIS library loads, then try to restore session
function gtOnGisLoad() {
  if (getGtClientId()) {
    gtInitTokenClient();
    gtTryRestore();
  }
}
// GIS may load before or after our script
if (typeof google !== 'undefined' && google.accounts) {
  gtOnGisLoad();
} else {
  const origOnload = window.onload;
  window.onload = function() {
    if (origOnload) origOnload();
    setTimeout(gtOnGisLoad, 500);
  };
}

// ══════════════════════
//  SETTINGS / EXPORT / IMPORT
// ══════════════════════
function openSettings() {
  document.getElementById('settingsModal').classList.remove('hidden');
  renderBedtimeUI();
  renderAfternoonUI();
}
function closeSettings() {
  document.getElementById('settingsModal').classList.add('hidden');
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'daytracker-backup-' + todayKey() + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.days || !imported.settings) {
        alert('Invalid backup file: missing days or settings.');
        return;
      }
      if (!confirm('This will replace all current data. Continue?')) return;
      state = imported;
      save();
      renderAll();
      closeSettings();
    } catch(err) {
      alert('Could not read file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ══════════════════════
//  BEDTIME REMINDER
// ══════════════════════
function getBedtimeSettings() {
  if (!state.settings.bedtime) {
    state.settings.bedtime = { time: '22:30', offset: 0, ntfyTopic: 'wft2004-bedtime-a3x9' };
  }
  // migrate old shape
  if (state.settings.bedtime.ntfyTopic === undefined) {
    state.settings.bedtime.ntfyTopic = '';
    delete state.settings.bedtime.enabled;
  }
  return state.settings.bedtime;
}

function saveBedtimeTime() {
  getBedtimeSettings().time = document.getElementById('bedtimeTime').value;
  save();
  renderBedtimeUI();
}

function setBedtimeOffset(v) {
  getBedtimeSettings().offset = v;
  save();
  renderBedtimeUI();
}

function saveBedtimeNtfyTopic() {
  getBedtimeSettings().ntfyTopic = document.getElementById('bedtimeNtfyTopic').value.trim();
  save();
  renderBedtimeUI();
}

function bedtimeCron() {
  const b = getBedtimeSettings();
  const [bh, bm] = b.time.split(':').map(Number);
  let totalMin = bh * 60 + bm - b.offset;
  if (totalMin < 0) totalMin += 1440;
  const h = Math.floor(totalMin / 60) % 24;
  const m = totalMin % 60;
  return m + ' ' + h + ' * * *';
}

function renderBedtimeUI() {
  const b = getBedtimeSettings();
  // Time
  document.getElementById('bedtimeTime').value = b.time;
  // Offset pills
  const offPills = document.getElementById('bedtimeOffsetPills').querySelectorAll('.pill');
  offPills[0].classList.toggle('active', b.offset === 0);
  offPills[1].classList.toggle('active', b.offset === 15);
  offPills[2].classList.toggle('active', b.offset === 30);
  // ntfy topic
  const topicInput = document.getElementById('bedtimeNtfyTopic');
  if (topicInput.value.trim() !== b.ntfyTopic) topicInput.value = b.ntfyTopic;
  // Setup guide
  const guide = document.getElementById('bedtimeSetupGuide');
  if (!b.ntfyTopic) {
    guide.innerHTML = '';
    return;
  }
  const cron = bedtimeCron();
  const ntfyUrl = 'https://ntfy.sh/' + esc(b.ntfyTopic);
  const msg = b.offset > 0 ? b.offset + ' minutes until bedtime' : 'Time for bed!';
  guide.innerHTML =
    '<div style="margin-top:14px;padding:12px;background:var(--bg);border:1.5px solid var(--card-border);border-radius:10px;font-size:.82rem;line-height:1.6">' +
      '<strong style="color:var(--text-bright)">Setup guide</strong><br>' +
      '<span style="color:var(--text-dim)">1. Install the <a href="https://ntfy.sh" target="_blank" style="color:var(--accent)">ntfy app</a> on your phone</span><br>' +
      '<span style="color:var(--text-dim)">2. Subscribe to: <code style="color:var(--accent)">' + esc(b.ntfyTopic) + '</code></span><br>' +
      '<span style="color:var(--text-dim)">3. Create a cron job at <a href="https://cron-job.org" target="_blank" style="color:var(--accent)">cron-job.org</a>:</span><br>' +
      '<div style="margin:8px 0 4px;padding:8px 10px;background:var(--card-bg);border-radius:8px;font-family:monospace;font-size:.78rem;word-break:break-all">' +
        '<div style="color:var(--text-dim)">URL: <span style="color:var(--text-bright)">' + ntfyUrl + '</span></div>' +
        '<div style="color:var(--text-dim)">Method: <span style="color:var(--text-bright)">POST</span></div>' +
        '<div style="color:var(--text-dim)">Body: <span style="color:var(--text-bright)">' + esc(msg) + '</span></div>' +
        '<div style="color:var(--text-dim)">Schedule: <span id="bedtimeCronExpr" style="color:var(--text-bright)">' + esc(cron) + '</span>' +
          ' <button onclick="copyBedtimeCron()" style="background:none;border:1px solid var(--card-border);border-radius:4px;color:var(--accent);font-size:.72rem;padding:2px 8px;margin-left:6px;cursor:pointer">Copy</button></span></div>' +
      '</div>' +
    '</div>';
}

function copyBedtimeCron() {
  navigator.clipboard.writeText(bedtimeCron()).then(function() {
    var btn = document.querySelector('#bedtimeSetupGuide button');
    if (btn) { btn.textContent = 'Copied!'; setTimeout(function() { btn.textContent = 'Copy'; }, 1500); }
  });
}

// ══════════════════════
//  AFTERNOON RESET REMINDER
// ══════════════════════
function getAfternoonSettings() {
  if (!state.settings.afternoon) {
    state.settings.afternoon = { time: '14:00' };
  }
  return state.settings.afternoon;
}

function saveAfternoonTime() {
  getAfternoonSettings().time = document.getElementById('afternoonTime').value;
  save();
  renderAfternoonUI();
}

function afternoonCron() {
  const a = getAfternoonSettings();
  const [h, m] = a.time.split(':').map(Number);
  return m + ' ' + h + ' * * *';
}

function renderAfternoonUI() {
  const a = getAfternoonSettings();
  document.getElementById('afternoonTime').value = a.time;
  const guide = document.getElementById('afternoonSetupGuide');
  const b = getBedtimeSettings();
  if (!b.ntfyTopic) {
    guide.innerHTML = '<div style="font-size:.75rem;color:var(--text-dim);margin-top:8px">Set an ntfy topic in Bedtime Reminder above first.</div>';
    return;
  }
  const cron = afternoonCron();
  const ntfyUrl = 'https://ntfy.sh/' + esc(b.ntfyTopic);
  guide.innerHTML =
    '<div style="margin-top:14px;padding:12px;background:var(--bg);border:1.5px solid var(--card-border);border-radius:10px;font-size:.82rem;line-height:1.6">' +
      '<strong style="color:var(--text-bright)">Cron job setup</strong><br>' +
      '<span style="color:var(--text-dim)">Create a second cron job at <a href="https://cron-job.org" target="_blank" style="color:var(--accent)">cron-job.org</a>:</span><br>' +
      '<div style="margin:8px 0 4px;padding:8px 10px;background:var(--card-bg);border-radius:8px;font-family:monospace;font-size:.78rem;word-break:break-all">' +
        '<div style="color:var(--text-dim)">URL: <span style="color:var(--text-bright)">' + ntfyUrl + '</span></div>' +
        '<div style="color:var(--text-dim)">Method: <span style="color:var(--text-bright)">POST</span></div>' +
        '<div style="color:var(--text-dim)">Body: <span style="color:var(--text-bright)">Afternoon reset \u2014 open your midday check-in!</span></div>' +
        '<div style="color:var(--text-dim)">Schedule: <span id="afternoonCronExpr" style="color:var(--text-bright)">' + esc(cron) + '</span>' +
          ' <button onclick="copyAfternoonCron()" style="background:none;border:1px solid var(--card-border);border-radius:4px;color:var(--accent);font-size:.72rem;padding:2px 8px;margin-left:6px;cursor:pointer">Copy</button></span></div>' +
      '</div>' +
    '</div>';
}

function copyAfternoonCron() {
  navigator.clipboard.writeText(afternoonCron()).then(function() {
    var btn = document.querySelector('#afternoonSetupGuide button');
    if (btn) { btn.textContent = 'Copied!'; setTimeout(function() { btn.textContent = 'Copy'; }, 1500); }
  });
}

// ══════════════════════
//  TODAY PROGRESS
// ══════════════════════
function renderTodayProgress() {
  const d = getDay();
  const anchorList = state.settings.anchors || DEFAULT_ANCHORS;
  const btItems = getBedtimeItems();
  let done = 0, total = 0;

  // Wake
  total++; if (d.wake && d.wake.time) done++;
  // Anchors
  anchorList.forEach(a => { total++; if (d.anchors && d.anchors[a]) done++; });
  // Midday priorities
  if (d.midday && d.midday.priorities) {
    d.midday.priorities.forEach(p => { if (p.text) { total++; if (p.done) done++; } });
  }
  // Bedtime
  btItems.forEach(item => { total++; if (d.wake && d.wake.bedtimeChecklist && d.wake.bedtimeChecklist[item]) done++; });

  const pct = total > 0 ? Math.round(done / total * 100) : 0;

  // Streaks
  const anchorInfo = calcStreak(k => {
    const dd = state.days[k];
    return dd && dd.anchors && anchorList.every(a => dd.anchors[a]);
  });
  const btInfo = calcStreak(k => {
    const dd = state.days[k];
    return dd && dd.wake && dd.wake.bedtimeChecklist && btItems.every(item => dd.wake.bedtimeChecklist[item]);
  });

  let html = '<div class="today-progress">';
  html += '<div class="tp-pct">' + pct + '% complete today</div>';
  html += '<div class="tp-bar-track"><div class="tp-bar-fill" style="width:' + pct + '%"></div></div>';
  html += '<div class="tp-stats"><span>' + done + ' of ' + total + ' items</span></div>';
  html += '<div class="tp-streaks">';
  html += '<div class="tp-streak"><span class="tp-snum">' + anchorInfo.streak + '</span> anchors streak</div>';
  html += '<div class="tp-streak"><span class="tp-snum">' + btInfo.streak + '</span> bedtime streak</div>';
  html += '</div></div>';

  document.getElementById('todayProgress').innerHTML = html;
}

// ══════════════════════
//  INIT
// ══════════════════════
function renderAll() {
  document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  // ensure today exists
  getDay();
  save();
  renderTodayProgress();
  renderWake();
  renderAnchors();
  renderGoogleTasks();
  renderMidday();
  renderBedtime();
}

renderAll();

// ── PWA Service Worker ──
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
